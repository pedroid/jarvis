<!DOCTYPE html>
<html>
	<head>
		<script src="markdown.js"></script>
    <script src="/socket.io/socket.io.js"></script>
    <script src="//ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
	</head>
  <body>    
  <div class="header">
	<ul>
		<li><a href="../ui_cmd.html">Home</a></li>
	</ul>

</div>
	<div id="preview_link"></div>
	<div id="title">[Filename]</div>
    <textarea id="text-input" oninput="this.editor.update()"
              rows="6" cols="60">Type **Markdown** here.</textarea>
    <div id="preview"> </div>
    <script>
      var filename;
      var socket = io.connect();
      var current_dir = '';
      socket.on('markdown', function(data){
		switch(data.command){
			case 'link':
				$('#preview_link').html('<a href="'+data.link+'">preview</a>');
				break;
			case 'dir':
				$('#path').text('~/'+data.dir+'$');		
				break;				
			case 'edit':
				console.log(data.data);
				$('#text-input').val(data.data);
          			$('#preview').html(markdown.toHTML(data.data));
		}
	});
      socket.on('date', function(data) {
        $('#date').text(data.date);
      });
      socket.on('server_response', function(rawdata){
		if(rawdata.cmd == 'ls'){
			var dir_content = "";
			for(each_dir_index in rawdata.response_content){
				var each_dir = rawdata.response_content[each_dir_index];
				if(each_dir.length >1){
//					console.log(each_dir);
					if(each_dir.split('.')[each_dir.split('.').length-1] == 'html'){
//						console.log('html');
						dir_content+= '<a href="'+ rawdata.path + each_dir+'" target="_blank">'+each_dir+'</a></br>';
					}else if(each_dir.split('.')[each_dir.split('.').length-1] == 'markdown'){
						//console.log(each_dir);
						//dir_content+= '<a href="javascript:emit_edit('+'\'each_dir\''+')">'+each_dir+'</a></br>';
						dir_content+= '<a href="javascript:emit_edit('+'\''+each_dir+'\''+')">'+each_dir+'</a></br>';
				
					}else{
//						console.log('not html');
						dir_content+= each_dir+'</br>';
					}				
				}
			}
			//console.log(rawdata.response_content.length);
			$('#div_response').html(dir_content);
		}else{
			$('#div_response').html(rawdata.response_content);
		}
	});
	function emit_edit(filename){
	//	console.log(filename);
		socket.emit('markdown',{
			'type':'cmd',
			'command':'edit',
			'filename':filename
		});
	}
      socket.on('server_brd_message', function(rawdata){
		$('#broadcast_message').text(rawdata.message_content);
	});

      $(document).ready(function(){
	$('#text').focus(function(){
		$('#text').val("");
	});
	$('#text').val("input your command here\n");
        $('#text').keypress(function(e){
          //socket.emit('client_data', {
          //  'letter': String.fromCharCode(e.charCode)
          //}i);

	  if(e.charCode==13){ //enter(i.e. return)
		num_input_element = $('#text').val().split('\n').length;
//		console.log($('#text-input').val());
		var cmd;
		if(num_input_element==1){
			cmd = $('#text').val();
		}else{
			cmd = $('#text').val().split('\n')[1];
			
		}
		switch(cmd.split(' ')[0]){
			case('save'):{
//				console.log($('#text-input').html());
				if(filename){			
					socket.emit('markdown',{
						'type':'cmd',
						'command':'save',
						'markdown_content':$('#text-input').val(),
						'html_content':$('#preview').html(),
						'path':current_dir,
						'filename':filename
					});
					console.log('markdown content:'+$('#text-input').val());
					console.log('file saved');
					$('#client_response').html('file saved');
				}else{
					console.log('please select a file to edit');
					$('#client_response').html('please select a file to edit');
					break;
				}
				break;
			}
			case('ls'):{
//				console.log('ls');
				console.log('ls:'+current_dir);
				socket.emit('markdown',{
					'type':'cmd',
					'command':'ls',
					'path':current_dir
				});
				break;
			}
			case('mkdir'):{
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					socket.emit('markdown',{
						'type':'cmd',
						'command':'mkdir',
						'path':argv
					});
					
				}else{
					$('#client_response').html('please enter the directory name as argument[1]');

				}
				break;

			}
			case('cd'):{
				console.log('cmd:'+cmd);
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					socket.emit('markdown',{
						'type':'cmd',
						'command':'cd',
						'path':argv
					});

				}else{

					$('#client_response').html('please enter the filepath as argument[1]');
				}
				/*
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					if(argv=='..'){
						var new_path='';
						var path_tmp = current_dir.split('/');
						switch(path_tmp.length){
							case 2: console.log('you are alrealy in root');
								break;
							case 3: path_tmp.splice(1,1);break;
							case 4: path_tmp.splice(2,1);break;
						}
						for(var i=0;i<path_tmp.length;i++){
							new_path+=path_tmp[i];
							if(path_tmp[i]=='')break;
							new_path+='/';
						}
						console.log('2:'+new_path);
						current_dir = new_path;
					}else{
						current_dir += argv+'/';
					}
					$('#title').html('/'+current_dir+filename+'.markdown');
					
				}else{
					$('#client_response').html('please enter the filepath as argument[1]');
					
				}
				*/
				break;
			}
			case('rm'):{
				if(cmd.split(' ')[1]){
					argv = cmd.split(' ')[1];
					filename = argv;
					socket.emit('markdown',{
						'type':'cmd',
						'command':'rm',
						'filename':argv
					});
				}else{
					$('#client_response').html('please enter the filename as argument[1]');

				}
			}
			case('new'):{
				if(cmd.split(' ')[1]){					
					argv = cmd.split(' ')[1];
					filename = argv;
					$('#title').html(current_dir+filename+'.markdown');
					
				}else{
					console.log('please enter the filename as argument[1]');
					$('#client_response').html('please enter the filename as argument[1]');
				}
				break;

//				console.log('argv:'+argv);
			}
			case('clear'):{
				filename='';
				$('#title').html('[filename]');
				break;
			}
			/*
			case('pwd'):{
				
				socket.emit('markdown',{
					'type':'cmd',
					'command':'pwd'
				});
				
				break;
			}
			*/
			default:{
				$('#client_response').html('command not support.');
			}
		}

		$('#text').val('');
	   }
        });
      });
    </script>
    
    <script>
      function Editor(input, preview) {
        this.update = function () {
          preview.innerHTML = markdown.toHTML(input.value);
//	  console.log(preview.innerHTML);
        };
        input.editor = this;
        this.update();
      }
      var $$ = function (id) { return document.getElementById(id); };
      new Editor($$("text-input"), $$("preview"));
    </script>
    <p>cmd</p>
<div id='path'>~/$</div>	
    <textarea id="text" rows="1" cols="50"></textarea>
<p>client response:</p>
<div id='client_response'></div>	
    <p>server response:</p>
    <div id="div_response"></div>
  </body>
</html>
